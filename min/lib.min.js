"use strict";var _get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined}else{return get(parent,property,receiver)}}else if("value"in desc){return desc.value}else{var getter=desc.get;if(getter===undefined){return undefined}return getter.call(receiver)}};var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var Drawable=function(){function Drawable(){var x=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;var y=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var width=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var height=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var rot=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var opacity=arguments.length>5&&arguments[5]!==undefined?arguments[5]:1;_classCallCheck(this,Drawable);this.x=x|0;this.y=y|0;this.width=width|0;this.height=height|0;this.rot=+rot;this.opacity=+opacity;this.scaleX=1;this.scaleY=1}_createClass(Drawable,[{key:"draw",value:function draw(ctx){ctx.globalAlpha=this.opacity;if(this.rot!=0){var centerOffsetWidth=this.x+this.width/2|0;var centerOffsetHeight=this.y+this.height/2|0;ctx.translate(centerOffsetWidth,centerOffsetHeight);ctx.rotate(this.rot);ctx.scale(this.scaleX,this.scaleY);ctx.translate(-centerOffsetWidth,-centerOffsetHeight)}}}]);return Drawable}();var Rectangle=function(_Drawable){_inherits(Rectangle,_Drawable);function Rectangle(x,y,width,height,rot,opacity,color){_classCallCheck(this,Rectangle);var _this=_possibleConstructorReturn(this,(Rectangle.__proto__||Object.getPrototypeOf(Rectangle)).call(this,x,y,width,height,rot,opacity));_this.color=color+"";return _this}_createClass(Rectangle,[{key:"draw",value:function draw(ctx){ctx.save();_get(Rectangle.prototype.__proto__||Object.getPrototypeOf(Rectangle.prototype),"draw",this).call(this,ctx);if(this.color)ctx.fillStyle=this.color;ctx.fillRect(this.x|0,this.y|0,this.width|0,this.height|0);ctx.restore()}}]);return Rectangle}(Drawable);var SimpleText=function(_Drawable2){_inherits(SimpleText,_Drawable2);function SimpleText(){var text=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var x=arguments[1];var y=arguments[2];var width=arguments.length>3&&arguments[3]!==undefined?arguments[3]:1e5;var height=arguments.length>4&&arguments[4]!==undefined?arguments[4]:14;var color=arguments.length>5&&arguments[5]!==undefined?arguments[5]:"#000";var font=arguments.length>6&&arguments[6]!==undefined?arguments[6]:"arial";var rot=arguments[7];var opacity=arguments[8];_classCallCheck(this,SimpleText);var _this2=_possibleConstructorReturn(this,(SimpleText.__proto__||Object.getPrototypeOf(SimpleText)).call(this,x,y,width,height,rot,opacity));_this2.text=text+"";_this2.font=font+"";_this2.color=color+"";return _this2}_createClass(SimpleText,[{key:"draw",value:function draw(ctx){ctx.save();_get(SimpleText.prototype.__proto__||Object.getPrototypeOf(SimpleText.prototype),"draw",this).call(this,ctx);ctx.font=this.height+"px "+this.font;ctx.fillStyle=this.color;ctx.textBaseline="top";ctx.fillText(this.text,this.x,this.y,this.width);ctx.restore()}}]);return SimpleText}(Drawable);var Sprite=function(_Drawable3){_inherits(Sprite,_Drawable3);function Sprite(image,x,y,width,height,rot,opacity){_classCallCheck(this,Sprite);if(image instanceof Image){if(image.naturalHeight==0)throw new TypeError("ParameterError: image is an Image but has no source or hasn't loaded yet!");var _this3=_possibleConstructorReturn(this,(Sprite.__proto__||Object.getPrototypeOf(Sprite)).call(this,x,y,width||image.naturalWidth,height||image.naturalHeight,rot,opacity));_this3.image=image;_this3.draw=_this3._imageDraw}else if(image instanceof Sprite.Sheet){var _this3=_possibleConstructorReturn(this,(Sprite.__proto__||Object.getPrototypeOf(Sprite)).call(this,x,y,width||image.subimageWidth,height||image.subimageHeight,rot,opacity));_this3.spriteSheet=image;_this3.subimage=0;_this3.draw=_this3._sheetDraw}else{throw new TypeError("ParameterError: image must be an Image or SpriteSheet object!")}return _possibleConstructorReturn(_this3)}_createClass(Sprite,[{key:"_imageDraw",value:function _imageDraw(ctx){ctx.save();_get(Sprite.prototype.__proto__||Object.getPrototypeOf(Sprite.prototype),"draw",this).call(this,ctx);ctx.drawImage(this.image,this.x|0,this.y|0,this.width|0,this.height|0);ctx.restore()}},{key:"_sheetDraw",value:function _sheetDraw(ctx){ctx.save();_get(Sprite.prototype.__proto__||Object.getPrototypeOf(Sprite.prototype),"draw",this).call(this,ctx);ctx.drawImage(this.spriteSheet.image,this.spriteSheet.getFrameX(this.subimage)|0,this.spriteSheet.getFrameY(this.subimage)|0,this.spriteSheet.subimageWidth|0,this.spriteSheet.subimageHeight|0,this.x|0,this.y|0,this.width|0,this.height|0);ctx.restore()}}]);return Sprite}(Drawable);Sprite.Sheet=function(){function _class(image,subimageWidth,subimageHeight,subimageCount){_classCallCheck(this,_class);if(!(image instanceof Image))throw new TypeError("ParameterError: image must be an Image or SpriteSheet object!");if(!subimageHeight)throw new TypeError("ParameterError: subimageHeight required!");if(!subimageWidth)throw new TypeError("ParameterError: subimageWidth required!");if(image.naturalHeight==0)throw new TypeError("ParameterError: image is an Image but has no source or hasn't loaded yet!");this.image=image;this.subimageHeight=subimageHeight|0;this.subimageWidth=subimageWidth|0;this._imagesPerRow=image.naturalWidth/subimageWidth|0;this._imagesPerColumn=image.naturalHeight/subimageHeight|0}_createClass(_class,[{key:"getFrameX",value:function getFrameX(subimage){return subimage%this._imagesPerRow%this._imagesPerRow*this.subimageWidth}},{key:"getFrameY",value:function getFrameY(subimage){return(subimage/this._imagesPerRow|0)%this._imagesPerColumn*this.subimageHeight}}]);return _class}();var View=function(){function View(){_classCallCheck(this,View)}_createClass(View,[{key:"drawView",value:function drawView(ctx,drawables){}}]);return View}();var SimpleView=function(_View){_inherits(SimpleView,_View);function SimpleView(){var dwidth=arguments.length>0&&arguments[0]!==undefined?arguments[0]:100;var dheight=arguments.length>1&&arguments[1]!==undefined?arguments[1]:100;var dx=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var dy=arguments.length>3&&arguments[3]!==undefined?arguments[3]:0;var sx=arguments.length>4&&arguments[4]!==undefined?arguments[4]:0;var sy=arguments.length>5&&arguments[5]!==undefined?arguments[5]:0;var zoomX=arguments.length>6&&arguments[6]!==undefined?arguments[6]:1;var zoomY=arguments.length>7&&arguments[7]!==undefined?arguments[7]:1;var backgroundColor=arguments[8];var smooth=arguments.length>9&&arguments[9]!==undefined?arguments[9]:true;_classCallCheck(this,SimpleView);var _this4=_possibleConstructorReturn(this,(SimpleView.__proto__||Object.getPrototypeOf(SimpleView)).call(this));_this4.dwidth=dwidth|0;_this4.dheight=dheight|0;_this4.dx=dx|0;_this4.dy=dy|0;_this4.sx=sx|0;_this4.sy=sy|0;_this4.zoomX=+zoomX;_this4.zoomY=+zoomY;_this4.smooth=!!smooth;_this4.backgroundColor=backgroundColor;return _this4}_createClass(SimpleView,[{key:"drawView",value:function drawView(ctx,drawables){ctx.save();if(this.backgroundColor){ctx.fillStyle=this.backgroundColor;ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height)}else{ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height)}ctx.setTransform(this.zoomX,0,0,this.zoomY,(this.dx-this.sx)*this.zoomX-this.dx|0,(this.dy-this.sy)*this.zoomY-this.dy|0);ctx.imageSmoothingEnabled=this.smooth;for(var i=0;i<drawables.length;i++){drawables[i].draw(ctx)}ctx.restore();ctx.clearRect(this.dx,0,ctx.canvas.width,this.dy);ctx.clearRect(this.dx+this.dwidth,this.dy,ctx.canvas.width,ctx.canvas.height);ctx.clearRect(0,this.dy+this.dheight,this.dx+this.dwidth,ctx.canvas.height);ctx.clearRect(0,0,this.dx,this.dy+this.dheight)}}]);return SimpleView}(View);var SceneManager=function(){function SceneManager(canvas){var fpscap=arguments.length>1&&arguments[1]!==undefined?arguments[1]:60;_classCallCheck(this,SceneManager);if(!canvas)throw new TypeError("Parametererror: canvas required!");this.canvas=canvas;this.ctxt=canvas.getContext("2d");this.fpscap=fpscap|0;this._debug={};this._debug.lastSecond=window.performance.now();this._debug.framesThisSecond=0}_createClass(SceneManager,[{key:"play",value:function play(scene){if(!scene)throw new TypeError("Parametererror: scene required!");this.scene=scene;scene.setSize(this.canvas.width,this.canvas.height);if(scene.play)scene.play();if(!this._running){this._running=true;this._loop()}}},{key:"stop",value:function stop(){if(scene.stop)scene.stop();this._running=false}},{key:"_loop",value:function _loop(){if(this._running)window.requestAnimationFrame(this._loop.bind(this));if(window.performance.now()>this._debug.lastSecond+1e3){this._debug.lastSecond=window.performance.now();this._debug.framesThisSecond=0}if(this.fpscap==60||this._debug.framesThisSecond<(window.performance.now()-this._debug.lastSecond)/1e3*this.fpscap){this.scene.drawScene(this.ctxt);this._debug.framesThisSecond++}}}]);return SceneManager}();var Scene=function(){function Scene(hooks,width,height){_classCallCheck(this,Scene);if(!hooks)throw new TypeError("Parametererror: hooks required!");this._osCanvas=document.createElement("canvas");this._osCanvas.width=width||100;this._osCanvas.height=height||100;this._osCtx=this._osCanvas.getContext("2d");this._drawableArr=[];this._viewHash={};this._viewArr=[];if(hooks.create){this.play=function(){hooks.create.bind(this)();if(hooks.play)hooks.play.bind(this)();this.play=hooks.play}}else{this.play=hooks.play}this.renderStart=hooks.renderStart||hooks.render;this.renderEnd=hooks.renderEnd;this.stop=hooks.stop;this.default_view=new SimpleView(this._osCanvas.width,this._osCanvas.height);this.addView(this.default_view)}_createClass(Scene,[{key:"setSize",value:function setSize(width,height){this._osCanvas.width=width||100;this._osCanvas.height=height||100;if(this.default_view){this.default_view.dwidth=width||100;this.default_view.dheight=height||100}}},{key:"drawScene",value:function drawScene(ctx){if(this.renderStart)this.renderStart();ctx.clearRect(0,0,this._osCanvas.width,this._osCanvas.height);for(var i=0;i<this._viewArr.length;i++){this._osCtx.clearRect(0,0,this._osCanvas.width,this._osCanvas.height);this._viewArr[i].drawView(this._osCtx,this._drawableArr);ctx.drawImage(this._osCanvas,0,0)}if(this.renderEnd)this.renderEnd()}},{key:"addView",value:function addView(view){var depth=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;if(!view)throw new TypeError("Parametererror: view required!");if(!(view instanceof View))throw new TypeError("Parametererror: view must be an instance of View!");view._rl_depth=depth;this._spliceIntoOrder(view,this._viewArr);view.remove=function(){this.removeView(view)}.bind(this);Object.defineProperty(view,"depth",{get:function get(){return this._rl_depth},set:function(newValue){this.setViewDepth(view,newValue)}.bind(this),enumerable:true,configurable:true});return view}},{key:"removeView",value:function removeView(view){this._viewArr.splice(view._rl_index,1);delete view.depth;delete view.remove;delete view._rl_depth;delete view._rl_index}},{key:"setViewDepth",value:function setViewDepth(){var depth=arguments.length>0&&arguments[0]!==undefined?arguments[0]:0;this._viewArr.splice(view._rl_index,1);view._rl_depth=depth;this._spliceIntoOrder(view,this._viewArr)}},{key:"getViewDepth",value:function getViewDepth(name){return view._rl_depth}},{key:"addDrawable",value:function addDrawable(drawable){var depth=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;if(!drawable)throw new TypeError("Parametererror: drawable required!");if(!(drawable instanceof Drawable))throw new TypeError("Parametererror: drawable must be an instance of Drawable!");drawable._rl_depth=depth;this._spliceIntoOrder(drawable,this._drawableArr);drawable.remove=function(){this.removeDrawable(drawable)}.bind(this);Object.defineProperty(drawable,"depth",{get:function get(){return this._rl_depth},set:function(newValue){this.setDrawableDepth(drawable,newValue)}.bind(this),enumerable:true,configurable:true});return drawable}},{key:"removeDrawable",value:function removeDrawable(drawable){this._drawableArr.splice(drawable._rl_index,1);delete drawable.depth;delete drawable.remove;delete drawable._rl_depth;delete drawable._rl_index}},{key:"setDrawableDepth",value:function setDrawableDepth(drawable){var depth=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;this._drawableArr.splice(drawable._rl_index,1);drawable._rl_depth=depth;this._spliceIntoOrder(drawable,this._drawableArr)}},{key:"getDrawableDepth",value:function getDrawableDepth(name){return drawable._rl_depth}},{key:"_spliceIntoOrder",value:function _spliceIntoOrder(object,arr){var low=0,high=arr.length;while(low<high){var mid=low+high>>>1;if(arr[mid]._rl_depth<object._rl_depth)low=mid+1;else high=mid}object._rl_index=low;arr.splice(low,0,object);for(var i=low+1;i<arr.length;i++){arr[i]._rl_index++}}}]);return Scene}();var SceneWithLoader=function(_Scene){_inherits(SceneWithLoader,_Scene);function SceneWithLoader(hooks,width,height){_classCallCheck(this,SceneWithLoader);var create=hooks.create;var renderStart=hooks.renderStart||hooks.render;var renderEnd=hooks.renderEnd;hooks.renderStart=hooks.loadRenderStart||hooks.loadRender;hooks.renderEnd=hooks.loadRenderEnd;hooks.create=function(){hooks.preload.bind(_this5)();_this5.load.start()};var _this5=_possibleConstructorReturn(this,(SceneWithLoader.__proto__||Object.getPrototypeOf(SceneWithLoader)).call(this,hooks,width,height));_this5.load=new MediaLoader;_this5.load.onComplete(function(){_this5.renderStart=renderStart;_this5.renderEnd=renderEnd;create.bind(_this5)()});return _this5}return SceneWithLoader}(Scene);var MediaLoader=function(){function MediaLoader(){_classCallCheck(this,MediaLoader);this.total=0;this.progress=0;this._loadArr=[];this._progressEvents=[];this._completeEvents=[]}_createClass(MediaLoader,[{key:"onProgress",value:function onProgress(func){if(!func)throw new TypeError("ParameterError: func callback required!");this._progressEvents.push(func)}},{key:"onComplete",value:function onComplete(func){if(!func)throw new TypeError("ParameterError: func callback required!");this._completeEvents.push(func)}},{key:"image",value:function image(src){this.total++;var temp=new Image;this._loadArr.push({obj:temp,src:src});temp.onload=function(){var _this6=this;this.progress++;if(this.progress==this.total)this._completeEvents.forEach(function(f){return f()});else this._progressEvents.forEach(function(f){return f(_this6.progress,_this6.total)})}.bind(this);temp.onerror=function(){throw new Error("Error loading image: "+src)};return temp}},{key:"audio",value:function audio(src){this.total++;var temp=new Audio;temp.preload="auto";this._loadArr.push({obj:temp,src:src});temp.oncanplaythrough=function(){var _this7=this;this.progress++;temp.oncanplaythrough=null;if(this.progress==this.total)this._completeEvents.forEach(function(f){return f()});else this._progressEvents.forEach(function(f){return f(_this7.progress,_this7.total)})}.bind(this);temp.onerror=function(){throw new Error("Error loading audio: "+src)};return temp}},{key:"start",value:function start(){if(this.total==0)this._completeEvents.forEach(function(f){return f()});this._loadArr.forEach(function(e){e.obj.src=e.src})}}]);return MediaLoader}();var Input=function(){function Input(){var _this8=this;var el=arguments.length>0&&arguments[0]!==undefined?arguments[0]:document.body;_classCallCheck(this,Input);if(!(el instanceof HTMLElement||el instanceof HTMLDocument))throw new TypeError("ParameterError: el must be a valid HTML element!");this._el=el;if(el.tabIndex==-1)el.tabIndex=1;this.keysDown={};this.buttonsDown={};this.mousePos={x:0,y:0};this.tilt={abs:false,z:0,x:0,y:0};this._mouseEvents={down:[],up:[],move:[]};this._keyEvents={down:[],up:[]};this._tiltEvents=[];window.addEventListener("deviceorientation",function(e){_this8._tiltEvents.forEach(function(o){return o()});_this8.tilt={abs:e.absolute,z:e.alpha,x:e.beta,y:e.gamma}});el.oncontextmenu=function(e){return e.preventDefault()};el.onmousedown=function(e){e.preventDefault();e.target.focus();_this8.buttonsDown[e.button]=true;_this8._mouseEvents.down.forEach(function(o){if(o.button!=undefined){if(o.button==e.button)o.func(e.button)}else o.func(e.button)})};el.onmouseup=function(e){e.preventDefault();e.target.focus();_this8.buttonsDown[e.button]=false;_this8._mouseEvents.up.forEach(function(o){if(o.button!=undefined){if(o.button==e.button)o.func(e.button)}else o.func(e.button)})};el.onmousemove=function(e){_this8._mouseEvents.move.forEach(function(o){return o.func()});var _canvas$getBoundingCl=canvas.getBoundingClientRect(),left=_canvas$getBoundingCl.left,top=_canvas$getBoundingCl.top;_this8.mousePos.x=e.clientX-left;_this8.mousePos.y=e.clientY-top};el.onkeydown=function(e){if(!_this8.keysDown[e.key.toLowerCase()]){e.preventDefault();_this8.keysDown[e.key.toLowerCase()]=true;_this8._keyEvents.down.forEach(function(o){if(o.key){if(o.key==e.key.toLowerCase())o.func(e.key)}else o.func(e.key)})}};el.onkeyup=function(e){e.preventDefault();_this8.keysDown[e.key.toLowerCase()]=false;_this8._keyEvents.up.forEach(function(o){if(o.key){if(o.key==e.key.toLowerCase())o.func(e.key)}else o.func(e.key)})}}_createClass(Input,[{key:"setCursor",value:function setCursor(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key]}this._el.style.cursor=args.reduce(function(a,c){return a+c+", "},"")+"auto"}},{key:"onMouse",value:function onMouse(eventName,func,button){if(!eventName)throw new TypeError("ParameterError: eventName required!");if(!func)throw new TypeError("ParameterError: func callback required!");if(!this._mouseEvents[eventName])throw new Error(eventName+" is not a valid event!");if(typeof button=="string")button=this._stringToMouseCode(button);this._mouseEvents[eventName].push({func:func,button:button})}},{key:"unMouse",value:function unMouse(eventName,func){if(!eventName)throw new TypeError("ParameterError: eventName required!");if(!func)throw new TypeError("ParameterError: func callback required!");if(!this._mouseEvents[eventName])throw new Error(eventName+" is not a valid event!");var find=this._mouseEvents[eventName].findIndex(function(f){return f.func===func});if(find===-1)throw new Error("func is not a registered key listener!");this._mouseEvents[eventName].splice(find,1)}},{key:"onKey",value:function onKey(eventName,func,key){if(!eventName)throw new TypeError("ParameterError: eventName required!");if(!func)throw new TypeError("ParameterError: func callback required!");if(!this._keyEvents[eventName])throw new Error(eventName+" is not a valid event!");this._keyEvents[eventName].push({func:func,key:key?key.toLowerCase():undefined})}},{key:"unKey",value:function unKey(eventName,func){if(!eventName)throw new TypeError("ParameterError: eventName required!");if(!func)throw new TypeError("ParameterError: func callback required!");if(!this._keyEvents[eventName])throw new Error(eventName+" is not a valid event!");var find=this._keyEvents[eventName].findIndex(function(f){return f.func===func});if(find===-1)throw new Error("func is not a registered key listener!");this._keyEvents[eventName].splice(find,1)}},{key:"onTilt",value:function onTilt(func){if(!func)throw new TypeError("ParameterError: func callback required!");this._tiltEvents.push(func)}},{key:"unTilt",value:function unTilt(func){if(!func)throw new TypeError("ParameterError: func callback required!");var find=this._tiltEvents.findIndex(function(f){return f.func===func});if(find===-1)throw new Error("func is not a registered key listener!");this._tiltEvents.splice(find,1)}},{key:"checkKey",value:function checkKey(key){return this.keysDown[key.toLowerCase()]?true:false}},{key:"checkButton",value:function checkButton(button){if(typeof button=="string")button=this._stringToMouseCode(button);return this.buttonsDown[button]?true:false}},{key:"_stringToMouseCode",value:function _stringToMouseCode(str){switch(str.toLowerCase()){case"left":return 0;case"middle":return 1;case"right":return 2}}}]);return Input}();